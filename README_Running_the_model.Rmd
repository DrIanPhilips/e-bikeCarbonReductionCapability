---
title: "Estimating capability of e-bike use to reduce car CO2"
author: "Ian philips"
date: "28 April 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Introduction 

This R Markdown document shows the procedure for estimating the capability to replace car km with ebike walking and cycling and then estimating the CO2 reduction capability.  

The model was built using several stages.  The different stages were executed using different scripts and functions.  

This markdown shows the order of the scripts.  It also gives and overview of the main procerdures performed in each script.  
Each script has been commented and checked to ensure it runs.  
Some scripts call functions. 

Not all data used in the model is open data, so the full data is not provided at present.  

## Setup 
load required packages.  
create a datetime variable so that outputs from a particular model run are saved together in their own directory 


```{r doingsetup, results="hide", message = FALSE, warning=FALSE}
source("RscriptsExample/01_setupExample.R")

```

## Read the base synthetic population 

The base population is constructed using Kirk Harland's FMF software.  the Script BuildDataITS121_161019.R takes the output from the FMF software and joins it to data on slope, and the individual attributes of the individuals in the microdata sample. The script is included in the repo for information but is not run from this markdown.  

(Harland, K., 2013. Flexible Modelling Framework. MASS research group University of Leeds, University of Leeds.)

It used a simulated annealing procedure cloning individuals.  These  individuals were adapted from the Health survey for England and included estimates of cycling power output below a threshold which can be maintained for at least an hour.  

Calculations of pedal power are based on Philips et al https://doi.org/10.1080/15568318.2017.1368748
and Macklon et al https://starconference.org.uk/star/2019/Macklon.pdf

We do not provide the HSE data as this requires access via the UK Data Service.  


```{r readPopulation,results="hide"}
#popfile <- read_csv("MDOfiles/Eden.csv")

source("RscriptsExample/02_read_base_populationExample.R")



```


## Estimate the maximum daily travel distance For e-bikes, walking and cycling 
functions are used to calculate the speed and maximum distance. 
the file contains functioncycle_dist
which calls other functions: 
speed_iterative 
down_speed_iterative


functioncycle_dist estimates the maximum distance by 

* walk
* bike 
* e-bike (based on UK rules  - maximum 250 watt motor pedal assist, upto 3x assistance ratio)


#### simplifying assumptions
we assume a bikes weigh 15kg, e-bikes weigh 20 we assume people are carrying 15kg with them.  
e.g. change of clothes and a laptop shopping, toddler in a child seat.  

we assume people are physically capable of travelling 1 hour in the morning and 1 hour in the afternoon each day without injury.  (follownig Philips et al http://dx.doi.org/10.1080/15568318.2017.1368748) 

We assume carrying bags, paniers etc will increase drag. 
8% is a basic estimate 
#https://www.cyclingabout.com/speed-difference-between-panniers-bikepacking-bags-aerodynamic-testing-results/

We also assume that carrying cargo will increase muscular effort 
following the basic notion of Langmuir's corrections 
(Langmiur estimated hiking speeds) that carrying 15kg, 
would reduce speed by 20% for bikes going uphill and walking uphill, downhill and on the flat. 

we account for hilliness and we make the simplifying assumption of no wind.  

circuity is accounted for - car travel distance checks of NTS data are in euclidean distances
http://doc.ukdataservice.ac.uk/doc/5340/mrdoc/pdf/5340_nts_technical_report_2016.pdf (P37).  


#### Main blocks of code in this section
The script below calls funtions to calculate speed and distance: 
functions/speedDistanceFuncBikeEbike160120df3.R

It saves an intermediate output in the MDOfiles directory


```{r maxdistoptions, message = FALSE, warning=FALSE,results="hide"}
source("RscriptsExample/03_MDOITS121_150120_CARRY15aero8ms20.R")

```

## Estimate capability to replace car km travelled 


#### Main bolocks of code in this section


* Read results of script 03

* Then assign annual car travel distance. A distribution of car km travelled given geodemographic segmentwas derived from NTS individual anonymised data from UKData service. This was calibrated against LSOA estimates of total private car km.  Whether a person has access to a car was also accounted for. The distribution of car trip lengths are also considered.  The model at present doesn't consider trip chain tours.  

* Calculations are performed on individuals, to estimate the car km they are able to replace.  Using LSOA estimates of the CO2 emissions per car km we then estimate the car emissions.  Emissions per e-bike km are also calculated and the savings are then calculated.  


* Individual results are aggregated to LSOA level and are also summarised by gender and by Rural Urban Classification.  

* Script 04 calls script 05 once for each draw.  Script 5 calls functions 
function_MDD_savings290819.R, functionDODrawDistandSavings040919.R, functionDODrawDistandSavingsALLBIKE040919.R



```{r calculateKmREplaceCO2save, message = FALSE, warning=FALSE,results="hide"}
source("RscriptsExample/04_ senstest130220.R")
```


## Tabulate LSOA level indicators 

Attributes such as car and bike availability are allocated with montecarlo sampling.  There are several draws of each set of results.  The mean result from several draws is used and tabulated into a set of LSOA results.  



```{r tabulateLSOAresult,message = FALSE, warning=FALSE,results="hide"}
source("RscriptsExample/06.R")
```





