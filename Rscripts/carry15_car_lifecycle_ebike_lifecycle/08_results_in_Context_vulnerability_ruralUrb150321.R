#Results in context of vulnerabilty
#and rural urban classification



#------------ packages required --------- 
require(tidyverse)
require(tmap)
require(tmaptools)
require(data.table)
require(sf)


#--------------- remove objects  to tidy up--------------- 
rm(list=setdiff(ls(), c("datetime")))


#-------- read data-------------
#LSOA results
MDO_LSOA <- read_csv(paste0("Results", datetime, "/multidrawmeans.csv"))
#summaries at individual level
summary_lsoa <- read_csv(paste0("Results", datetime, "/multidrawSE_propn.csv"))

#read LSOA contextual data
context <- read_csv("LSOAcontextdata/contextualisingLSOAdataEng080619.csv")
SOAclass <- read_csv("LSOAcontextdata/censusSOAclass.csv")


gc()

MDO_LSOA <- MDO_LSOA %>% rename(LSOA11CD = 'lsoa1$LSOA11CD')

#
MDO_LSOA  <- MDO_LSOA %>% filter(!is.na(sumAllbikeco2save))
MDO_LSOA <- as.data.frame(MDO_LSOA)

names(MDO_LSOA)
names(context)


#remove duplicate rows from context
context <- as.data.frame(context)
context <- select(context,-c(LSOA01CD,LSOA01NM,CHGIND))
context <- distinct(context)
#check for any codes that are not english LSOAs 
context <- context %>% filter(substr(LSOA11CD,1,3) == "E01")


MDO_LSOA <- left_join(MDO_LSOA,context,by=c("LSOA11CD" ="LSOA11CD"))
names(MDO_LSOA)
MDO_LSOA <- distinct(MDO_LSOA)



names(SOAclass)
MDO_LSOA <- left_join(MDO_LSOA,SOAclass,by=c("LSOA11CD" = "SOACode"))
names(MDO_LSOA)



#--------------- prep data for mapping ---------------- 
names(MDO_LSOA)
#read spatial boundaries
lsoa <- st_read(dsn = "GISdata/LSOA11SG",layer = "LSOAEW11SG")
#library(dplyr)
england_bdy <- st_read(dsn = "GISdata/England_ol_2011", layer = "england_ol_2011")


#------------- join sf to mdo_lsoa data ------------- 
names(MDO_LSOA)
#lsoa <- left_join(lsoa, MDO_LSOA, by = c("lsoa11cd"="lsoa1$LSOA11CD"))
lsoa <- left_join(lsoa, MDO_LSOA, by = c("lsoa11cd"="LSOA11CD"))

names(lsoa)
gc()
#the figures in the results are in grams.  convert to tonnes divide by 1 million. 
#could probably use apply here to act over several columns.  
lsoa$sumdiffMDDco2save_AllEbikeco2save <- lsoa$sumdiffMDDco2save_AllEbikeco2save/ 1000000
lsoa$sumdiffAllbike_AllEbikeco2save <- lsoa$sumdiffAllbike_AllEbikeco2save /1000000
lsoa$sumdiffMDD_currentEbikeco2save <- lsoa$sumdiffMDD_currentEbikeco2save /1000000
lsoa$sumwalktoebikeco2save <- lsoa$sumwalktoebikeco2save /1000000

lsoa$sumWalkco2save <- lsoa$sumWalkco2save/1000000
lsoa$sumMDDco2save <- lsoa$sumMDDco2save / 1000000 
lsoa$sumAllbikeco2save <- lsoa$sumAllbikeco2save / 1000000
lsoa$sumAllEbikeco2save <- lsoa$sumAllEbikeco2save/1000000

lsoa$sumcurrentEbikeco2save <- lsoa$sumcurrentEbikeco2save /1000000
lsoa$sumcairnsco2save <- lsoa$sumcairnsco2save /1000000

#mean
lsoa$meandiffMDDco2save_AllEbikeco2save <- lsoa$meandiffMDDco2save_AllEbikeco2save/ 1000000
lsoa$meandiffAllbike_AllEbikeco2save <- lsoa$meandiffAllbike_AllEbikeco2save /1000000
lsoa$meandiffMDD_currentEbikeco2save <- lsoa$meandiffMDD_currentEbikeco2save /1000000
lsoa$meanwalktoebikeco2save <- lsoa$meanwalktoebikeco2save /1000000


lsoa$meanWalkco2save <- lsoa$meanWalkco2save/1000000
lsoa$meanMDDco2save <- lsoa$meanMDDco2save / 1000000 
lsoa$meanAllbikeco2save <- lsoa$meanAllbikeco2save / 1000000
lsoa$meanAllEbikeco2save <- lsoa$meanAllEbikeco2save/1000000

lsoa$meancurrentEbikeco2save <- lsoa$meancurrentEbikeco2save /1000000
lsoa$meancairnsco2save <- lsoa$meancairnsco2save /1000000


#------ remove welsh LSOAs -------------------- 

lsoa <- lsoa %>% filter(substr(lsoa11cd,1,1) != "W")
lsoa <- lsoa %>% filter(substr(lsoa11cd,1,1) != "w")
lsoa <- lsoa %>% filter(substr(lsoa11cd,1,1) != "S") # no scottish or NI dzs 
lsoa <- lsoa %>% filter(substr(lsoa11cd,1,1) != "9")

#check for any codes that are not lsoas
lsoa <- lsoa %>% filter(substr(lsoa11cd,1,3) == "E01")
#remove duplicate rows
lsoa <- lsoa %>% distinct(.keep_all = TRUE)
# 
# lsoa_duplicates = lsoa %>% group_by(lsoa11cd)%>%
#   summarise(n = n()) %>% filter(n >1)
# filtered <- lsoa %>% filter(lsoa11cd =="E01003502")
# filtered = distinct(filtered)


#-------------------- contextualising savings ---------------------------- 



#--------savings in context of Vulnerability Figure 5 -------

summary(lsoa$index,na.rm = T) 
lowQuartileVul <- -1.0736 #bottom quartile
highQuartileVul <- 1.3098 #top quartile
summary(lsoa$meanAllEbikeco2save)

#this should also run ok for cartailpipe and ebike lifecycle 
highQuartileco2savings <- quantile(lsoa$meanAllEbikeco2save, 0.75) # 0.748 (car and ebike lifecycle) #top quartile
lowQuartileco2savings <- quantile(lsoa$meanAllEbikeco2save, 0.25) #0.347 (car and ebike lifecycle)  # bottom quartile

lsoa$vulquads <- "not target"
lsoa$vulquads[lsoa$index > highQuartileVul & lsoa$meanAllEbikeco2save > highQuartileco2savings] <- "High vulnerability high savings"
lsoa$vulquads[lsoa$index > highQuartileVul & lsoa$meanAllEbikeco2save < lowQuartileco2savings] <- "High vulnerability low savings"
lsoa$vulquads[lsoa$index < lowQuartileVul & lsoa$meanAllEbikeco2save > highQuartileco2savings] <- "Low vulnerability high savings"
lsoa$vulquads[lsoa$index < lowQuartileVul & lsoa$meanAllEbikeco2save < lowQuartileco2savings] <- "Low vulnerability low savings"



#get the pallette details
library(RColorBrewer)
brewer.pal(n = 8, name = "Dark2")

pal1 <- c("forestgreen","red","orange","olivedrab2","gray83")


p <- ggplot(lsoa)+
  geom_point(aes(x=index,y=sumAllEbikeco2save,col = as.factor(vulquads)))+
  #scale_color_brewer(palette="Dark2")
  scale_color_manual(values= pal1,name = "grouped LSOAs")+
  labs(title = "", 
       x = "Vulnerability index", 
       y = "Sum CO2 savings pa (car to e-bike)",
       fill = "grouped LSOAs")+
  theme(axis.text=element_text(size=16),
        axis.title=element_text(size=20,face="bold"))
p


ggsave(file = paste0("plotsmaps",datetime,"/co2andvul_larger_axis_labs.jpg")) 

gc()
#remove missing 
#summary(lsoa$sumco2savepaEbike)

filtered <- lsoa  %>% filter(vulquads == "High vulnerability high savings")#carlifecycle3436 #distribution150321: 3294 3381(150321) 
nrow(filtered)
filtered <- lsoa  %>% filter(vulquads == "High vulnerability low savings")#carlifecycle912 #1197 1081
nrow(filtered)


filtered <- filtered %>% filter(RegionCountry %in%
                                  c("North West","Yorkshire and The Humber","North East","West Midlands","East Midlands"))#728
filtered <- filtered %>% filter(RegionCountry %in%c("North West","Yorkshire and The Humber","North East"))#406 in north

filtered <- lsoa  %>% filter(vulquads == "High vulnerability low savings")#carlifecycle912 #1197 1081
nrow(filtered)
filtered <- filtered %>% filter(RegionCountry %in%
                                  c("London","South East"))#106 london
filtered <- filtered %>% filter(RegionCountry %in%
                                  c("London"))#33 london


filtered <- lsoa  %>% filter(vulquads == "Low vulnerability high savings")#carlifecycle1035 #1091 1057
nrow(filtered)

filtered <- filtered %>% filter(RegionCountry %in%
                                  c("London","South East","East"))#681 
filtered <- filtered %>% filter(RegionCountry %in%
                                  c("London"))#33 london


filtered <- lsoa  %>% filter(vulquads == "Low vulnerability low savings")#carlifecycle #3967   3729    
nrow(filtered)
filtered <- lsoa %>% filter(!is.na(vulquads))
nrow(filtered)


#
head(lsoa$RegionCountry)


#select lsoas for mapping
filtered <- lsoa  %>% filter(vulquads == 
                               "High vulnerability high savings" | 
                               vulquads == "High vulnerability low savings" | 
                               vulquads == "Low vulnerability high savings"|
                               vulquads == "Low vulnerability low savings"|
                               vulquads =="no target")

namei <- "vulquads"
print(namei)
m <- tm_shape(filtered) +
  tm_fill(namei,lty = 0, lwd = 0,border.alpha = 0,
          #style= 'fisher',
          #style = "fixed",
          #breaks = breaks,
          palette = pal1,
          title = "CO2 savings &\nVulnerability",legend.hist = F)+
  tm_scale_bar(position =  c("right", "bottom"),color.dark = "gray",text.color = "gray",text.size = 0.4)+
  tm_layout(frame = T, legend.position = c("left", "top"),
            legend.height = 0.6,legend.width = 0.6,
            legend.text.size = 1,frame.lwd = 0
  )
m

tmap_save(m,paste0("plotsmaps",datetime,"/",namei,"contextVul_legsize1.jpg"),
          height = 29.7,width = 21, unit = "cm",
          dpi = 300)


gc()



#------------------- check for the cause  of the low savings ----------------- 


#in the high vulnerabilty low savings 
filtered <- lsoa  %>% filter(vulquads == "High vulnerability low savings") #912

#car use is just 46% the national average 
#accessibility 89% of the national average, income is 49%
summary(filtered$meanweightedkm_pp)
summary(lsoa$meanweightedkm_pp)
mean(filtered$meanweightedkm_pp,na.rm = T) / mean(lsoa$meanweightedkm_pp,na.rm = T) #41 for carlifecycle
mean(filtered$OAtotptw,na.rm = T) / mean(lsoa$OAtotptw,na.rm = T) #86% which is better than average 
mean(filtered$income,na.rm = T) / mean(lsoa$income,na.rm = T) #47%  clc


#car ownership is 2/3 national average #65% clc
summary(filtered$Cars_pp)
summary(lsoa$Cars_pp)


#physical capability similar
summary(filtered$ebikeDailyDist)
summary(lsoa$ebikeDailyDist)

#hilliness similar
summary(filtered$Rdslope)
summary(lsoa$Rdslope)




#In the low vulnerability low savings group, car use is less than a third of the national average 
filtered <- lsoa  %>% filter(vulquads == "Low vulnerability low savings") #3568 
summary(filtered$meanweightedkm_pp)
summary(lsoa$meanweightedkm_pp)

#car ownership is half the national average #1/3 avg in clc
summary(filtered$Cars_pp)
summary(lsoa$Cars_pp)

#physical capability similar
summary(filtered$ebikeDailyDist)
summary(lsoa$ebikeDailyDist)

#hilliness # a little less hilly
summary(filtered$Rdslope)
summary(lsoa$Rdslope)




#In the hi vulnerability hi savings group, car use is less than a third of the national average 
filtered <- lsoa  %>% filter(vulquads == "High vulnerability high savings")#3436 clc 
summary(filtered$meanweightedkm_pp)
summary(lsoa$meanweightedkm_pp)

mean(filtered$meanweightedkm_pp,na.rm = T) / mean(lsoa$meanweightedkm_pp,na.rm = T) #2.05 times average # 2.05clc
mean(filtered$OAtotptw,na.rm = T) / mean(lsoa$OAtotptw,na.rm = T) #1.65 accessibility worse than average #same clc
mean(filtered$income,na.rm = T) / mean(lsoa$income,na.rm = T) #94% 95%clc


#car ownership is higher than national avg clc 1.36x
summary(filtered$Cars_pp)
summary(lsoa$Cars_pp)

#physical capability similar
summary(filtered$ebikeDailyDist)
summary(lsoa$ebikeDailyDist)

#hilliness
summary(filtered$Rdslope)
summary(lsoa$Rdslope)



# clcIn the lo vulnerability hi savings group, car 1.43 of the national average #
filtered <- lsoa  %>% filter(vulquads == "Low vulnerability high savings")#
summary(filtered$meanweightedkm_pp)
summary(lsoa$meanweightedkm_pp)

mean(filtered$meanweightedkm_pp,na.rm = T) / mean(lsoa$meanweightedkm_pp,na.rm = T) #1.4 times average
mean(filtered$OAtotptw,na.rm = T) / mean(lsoa$OAtotptw,na.rm = T) #1.13 accessibility worse than average #1.14 clc
mean(filtered$income,na.rm = T) / mean(lsoa$income,na.rm = T) #1.77 times the average # #same


#
summary(filtered$Cars_pp)
summary(lsoa$Cars_pp)

#physical capability
summary(filtered$ebikeDailyDist)
summary(lsoa$ebikeDailyDist)

#hilliness
summary(filtered$Rdslope)
summary(lsoa$Rdslope)



#------------ rural Urban classification Figure 6 -------------- 
# we want to know what types of places have 
# greatest net benefit for e-bikes - where
#ist the gap between mdd and ebike the greatest  

lsoa_vulquads <- lsoa %>% select(lsoa11cd,vulquads,RUC11) 

st_geometry(lsoa_vulquads) <- NULL 

write_csv(lsoa_vulquads,paste0("results",datetime,"/","lsoacd_vulquads_ruc11",".csv"))


data <- lsoa %>% select(lsoa11cd,RUC11,meanAllEbikeco2save,meanAllEbikeco2save30m,
                        meanAllEbikeco2saveFlex,meanAllEbikeco2save30mFlex,
                        meanMDDco2save,sumAllEbikeco2save,sumAllbikeco2save,meanAllbikeco2save)
st_geometry(data) <- NULL
data <- data %>% group_by(RUC11) %>%
  summarise(number_of_obs = n(),
            meanAllEbikeco2save =mean(meanAllEbikeco2save,na.rm=T),
            meanMDDco2save = mean(meanMDDco2save,na.rm=T),
            meanAllbikeco2save = mean(meanAllbikeco2save,na.rm = T),
            sumAllEbikeco2save = sum(sumAllEbikeco2save,na.rm = T),
            sumAllbikeco2save = sum(sumAllbikeco2save,na.rm = T)
            )


data <- data %>% na.omit

data$ratioMDD = round((data$meanMDDco2save / data$meanAllEbikeco2save)*100,0)
data$ratiobike = round((data$meanAllbikeco2save / data$meanAllEbikeco2save)*100,0)
data$RU <- substr(data$RUC11,1,5)
data$ebike_pc_more_than_bike <- round((data$meanAllEbikeco2save/data$meanAllbikeco2save)*100,0) - 100
data$ebikesum_pc_more_than_bike <- round((data$sumAllEbikeco2save/data$sumAllbikeco2save)*100,0) - 100

write_csv(data,paste0("results",datetime,"/co2RUC_summary.csv"))

#--------------------- grey and blue plot used in revisions Figure 6
data2 <- data %>% dplyr::select(RUC11,ebike = meanAllEbikeco2save,bike = meanAllbikeco2save) 

library(ggthemes)
data2 %>% pivot_longer(cols  = ebike:bike ,
                       names_to = "mode", values_to = "V")%>%
  ggplot()+
  geom_bar(aes(x=as.factor(RUC11), y=V,fill = as.factor(mode)),
           stat="identity",position="dodge2")+
  scale_fill_hc()+
  #scale_fill_viridis(discrete = T, option = "G") +
  coord_flip()+
  xlab("Rural Urban classification")+
  ylab("mean carbon reduction capability Tonnes CO2 per person")+
  #scale_fill_discrete(name = "")+
  guides(fill=guide_legend(title=""))+
  annotate("text", x = 3.2, y = 0.85, label = "e-bikes 125% more than bikes",colour = "white")+
  annotate("text", x = 7.2, y = 0.65, label = "e-bikes 56% more than bikes",colour = "black")
  

ggsave(file = paste0("plotsmaps",datetime,"/ruc_diff.jpg")) 

#+
  #theme(axis.text.x = element_text(angle = 90))
 # theme_ipsum() 
  

data2$ebike_bike_ratio <- data2$ebike / data2$bike
write_csv(data2,paste0("results",datetime,"/co2RUC_summarydata2.csv"))


